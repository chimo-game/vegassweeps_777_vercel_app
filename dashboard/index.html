<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vegas Sweeps 777 â€” Analytics Dashboard</title>
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon" type="image/png" href="/favicon/vegassweeps_logo.png" />
  <link rel="apple-touch-icon" href="/favicon/vegassweeps_logo.png" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>

  <style>
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg: #0a0e1a;
      --surface: #111827;
      --surface-2: #1e293b;
      --border: rgba(255, 255, 255, 0.08);
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --purple: #8b5cf6;
      --radius: 14px;
    }

    /* ---- Password Gate ---- */
    .pw-gate {
      position: fixed;
      inset: 0;
      z-index: 9999;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 18px;
    }

    .pw-gate.hidden {
      display: none;
    }

    .pw-gate h2 {
      font-size: 1.5rem;
      color: var(--text);
    }

    .pw-gate p {
      color: var(--text-muted);
      font-size: 0.9rem;
    }

    .pw-gate input {
      padding: 12px 18px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-size: 1rem;
      width: 280px;
      outline: none;
      font-family: 'Outfit', sans-serif;
    }

    .pw-gate input:focus {
      border-color: var(--primary);
    }

    .pw-gate button {
      padding: 12px 32px;
      border-radius: 10px;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      font-family: 'Outfit', sans-serif;
    }

    .pw-gate button:hover {
      opacity: 0.9;
    }

    .pw-gate .pw-error {
      color: var(--danger);
      font-size: 0.85rem;
      min-height: 20px;
    }

    .pw-logo {
      font-size: 1.6rem;
      font-weight: 800;
    }

    .pw-logo span {
      color: var(--success);
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
    }

    a {
      text-decoration: none;
      color: inherit;
    }

    /* Layout */
    .app {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 240px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      padding: 24px 16px;
      position: fixed;
      top: 0;
      left: 0;
      bottom: 0;
      overflow-y: auto;
      z-index: 50;
    }

    .main {
      margin-left: 240px;
      flex: 1;
      padding: 24px;
      min-width: 0;
    }

    /* Sidebar */
    .sb-logo {
      font-size: 18px;
      font-weight: 800;
      margin-bottom: 8px;
      letter-spacing: -0.5px;
    }

    .sb-logo span {
      color: var(--warning);
    }

    .sb-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 28px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .sb-nav {
      list-style: none;
    }

    .sb-nav li {
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-muted);
      transition: all 0.15s;
      margin-bottom: 2px;
    }

    .sb-nav li:hover {
      background: var(--surface-2);
      color: var(--text);
    }

    .sb-nav li.active {
      background: rgba(59, 130, 246, 0.12);
      color: var(--primary);
      font-weight: 600;
    }

    .sb-nav li ion-icon {
      font-size: 18px;
    }

    .sb-status {
      position: absolute;
      bottom: 24px;
      left: 16px;
      right: 16px;
      padding: 12px;
      border-radius: 10px;
      background: var(--surface-2);
      font-size: 12px;
    }

    .sb-status .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .sb-status .dot.on {
      background: var(--success);
    }

    .sb-status .dot.off {
      background: var(--danger);
    }

    /* Header */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .page-header h1 {
      font-size: 22px;
      font-weight: 700;
      white-space: nowrap;
    }

    .date-range {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .date-btn {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }

    .date-btn:hover {
      border-color: rgba(255, 255, 255, 0.15);
      color: var(--text);
    }

    .date-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px;
    }

    .stat-card .label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-card .value {
      font-size: 28px;
      font-weight: 800;
    }

    .stat-card .change {
      font-size: 12px;
      font-weight: 600;
      margin-top: 4px;
    }

    .stat-card .change.up {
      color: var(--success);
    }

    .stat-card .change.down {
      color: var(--danger);
    }

    /* Panels */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 16px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .panel-header h3 {
      font-size: 16px;
      font-weight: 700;
    }

    /* Table */
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }

    .data-table th {
      text-align: left;
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
    }

    .data-table td {
      padding: 12px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
    }

    .data-table tr:last-child td {
      border-bottom: none;
    }

    .data-table tr:hover td {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Country flag */
    .country-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .country-flag {
      font-size: 18px;
      line-height: 1;
    }

    /* Bar chart (CSS only) */
    .bar-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .bar-label {
      width: 120px;
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bar-track {
      flex: 1;
      height: 24px;
      background: var(--surface-2);
      border-radius: 6px;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      padding-left: 8px;
      font-size: 11px;
      font-weight: 700;
      color: white;
    }

    .bar-fill.blue {
      background: linear-gradient(90deg, var(--primary), #2563eb);
    }

    .bar-fill.green {
      background: linear-gradient(90deg, var(--success), #059669);
    }

    .bar-fill.purple {
      background: linear-gradient(90deg, var(--purple), #7c3aed);
    }

    .bar-fill.orange {
      background: linear-gradient(90deg, var(--warning), #d97706);
    }

    /* Funnel */
    .funnel {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      gap: 12px;
      height: 220px;
      padding: 0 10px;
      margin-top: 8px;
      overflow: hidden;
    }

    .funnel-step {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      min-width: 0;
    }

    .funnel-bar {
      width: 100%;
      max-width: 80px;
      border-radius: 8px 8px 0 0;
      transition: height 0.5s ease;
      min-height: 10px;
    }

    .funnel-value {
      font-size: 13px;
      font-weight: 800;
      margin-top: 4px;
      line-height: 1;
    }

    .funnel-label {
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      line-height: 1.2;
    }

    /* Recent Events */
    .event-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border);
    }

    .event-row:last-child {
      border-bottom: none;
    }

    .event-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .event-dot.view {
      background: var(--primary);
    }

    .event-dot.signup {
      background: var(--success);
    }

    .event-dot.coupon {
      background: var(--warning);
    }

    .event-dot.offer {
      background: var(--purple);
    }

    .event-dot.activated {
      background: #10b981;
      box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
    }

    .event-text {
      flex: 1;
      font-size: 13px;
    }

    .event-text strong {
      font-weight: 600;
    }

    .event-time {
      font-size: 12px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 40px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Setup notice */
    .setup-notice {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(239, 68, 68, 0.05));
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: var(--radius);
      padding: 24px;
      margin-bottom: 24px;
    }

    .setup-notice h3 {
      color: var(--warning);
      margin-bottom: 8px;
    }

    .setup-notice p {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.7;
    }

    .setup-notice code {
      background: var(--surface-2);
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
      color: var(--primary);
    }

    .setup-notice ol {
      margin: 12px 0 0 20px;
      color: var(--text-muted);
      font-size: 14px;
    }

    .setup-notice ol li {
      margin-bottom: 6px;
    }

    /* Mobile hamburger */
    .mobile-header {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 60;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      align-items: center;
      justify-content: space-between;
      height: 56px;
    }

    .mobile-header .sb-logo {
      margin-bottom: 0;
    }

    .hamburger {
      background: none;
      border: none;
      color: var(--text);
      font-size: 28px;
      cursor: pointer;
      padding: 6px;
      display: flex;
      align-items: center;
    }

    .sidebar-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 49;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9000;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
    }

    .toast {
      pointer-events: auto;
      background: linear-gradient(135deg, #1a2332, #1e293b);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-left: 4px solid #10b981;
      border-radius: 12px;
      padding: 16px 20px;
      min-width: 320px;
      max-width: 420px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4), 0 0 20px rgba(16, 185, 129, 0.1);
      display: flex;
      align-items: flex-start;
      gap: 14px;
      transform: translateX(120%);
      opacity: 0;
      animation: toastSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      position: relative;
      overflow: hidden;
    }

    .toast::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 4px;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #10b981, #059669);
      animation: toastTimer 5s linear forwards;
      border-radius: 0 0 12px 0;
    }

    .toast.removing {
      animation: toastSlideOut 0.4s ease-in forwards;
    }

    .toast-icon {
      width: 42px;
      height: 42px;
      border-radius: 10px;
      background: rgba(16, 185, 129, 0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .toast-body {
      flex: 1;
      min-width: 0;
    }

    .toast-title {
      font-size: 14px;
      font-weight: 700;
      color: #10b981;
      margin-bottom: 3px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .toast-title .pulse-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulseDot 1.5s ease-in-out infinite;
    }

    .toast-msg {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.4;
    }

    .toast-msg strong {
      color: var(--text);
      font-weight: 600;
    }

    .toast-payout {
      font-size: 18px;
      font-weight: 800;
      color: #f59e0b;
      flex-shrink: 0;
      align-self: center;
    }

    .toast-close {
      position: absolute;
      top: 8px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      padding: 2px;
      line-height: 1;
      opacity: 0.5;
      transition: opacity 0.15s;
    }

    .toast-close:hover {
      opacity: 1;
    }

    @keyframes toastSlideIn {
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes toastSlideOut {
      to {
        transform: translateX(120%);
        opacity: 0;
      }
    }

    @keyframes toastTimer {
      from {
        width: 100%;
      }

      to {
        width: 0%;
      }
    }

    @keyframes pulseDot {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.4;
        transform: scale(0.7);
      }
    }

    /* Grid layouts */
    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Active Lockers */
    .active-lockers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
    }

    .locker-card {
      background: var(--surface-2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: border-color 0.3s, box-shadow 0.3s;
      position: relative;
      overflow: hidden;
    }

    .locker-card.hot {
      border-color: rgba(139, 92, 246, 0.4);
      box-shadow: 0 0 12px rgba(139, 92, 246, 0.1);
    }

    .locker-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
    }

    .locker-card-name {
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .locker-pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      flex-shrink: 0;
      animation: pulseDot 1.5s infinite;
    }

    .locker-pulse.idle {
      background: var(--text-muted);
      animation: none;
      opacity: 0.4;
    }

    .locker-stats {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .locker-stat {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .locker-stat strong {
      color: var(--text);
      font-size: 13px;
    }

    .locker-activity-bar {
      height: 3px;
      border-radius: 2px;
      background: var(--surface-2);
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
    }

    .locker-activity-fill {
      height: 100%;
      border-radius: 2px;
      background: linear-gradient(90deg, var(--purple), #818cf8);
      transition: width 0.6s ease;
    }

    .locker-last-activity {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Table scroll wrapper */
    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .grid-2 {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        z-index: 50;
        width: 260px;
        padding-top: 24px;
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .mobile-header {
        display: flex;
      }

      .main {
        margin-left: 0;
        padding: 16px;
        padding-top: 72px;
      }

      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .stat-card {
        padding: 14px;
      }

      .stat-card .value {
        font-size: 22px;
      }

      .stat-card .label {
        font-size: 11px;
      }

      .page-header h1 {
        font-size: 18px;
      }

      .date-btn {
        padding: 5px 10px;
        font-size: 12px;
      }

      .panel {
        padding: 14px;
      }

      .grid-2 {
        grid-template-columns: 1fr;
      }

      .funnel {
        height: 180px;
        gap: 8px;
        padding: 0 4px;
      }

      .funnel-value {
        font-size: 12px;
      }

      .funnel-label {
        font-size: 9px;
      }

      .funnel-bar {
        max-width: 60px;
      }

      .bar-label {
        width: 90px;
        font-size: 12px;
      }

      .event-text {
        font-size: 12px;
      }

      .event-time {
        font-size: 11px;
      }

      .data-table th {
        font-size: 10px;
        padding: 8px 6px;
      }

      .data-table td {
        font-size: 12px;
        padding: 8px 6px;
      }
    }

    @media (max-width: 480px) {
      .stats-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .stat-card .value {
        font-size: 18px;
      }

      .stat-card .label {
        font-size: 10px;
      }

      .stat-card {
        padding: 12px;
      }

      .main {
        padding: 10px;
        padding-top: 66px;
      }

      .page-header {
        margin-bottom: 12px;
      }

      .page-header h1 {
        font-size: 16px;
      }

      .date-range {
        width: 100%;
      }

      .date-btn {
        flex: 1;
        text-align: center;
        padding: 6px 4px;
        font-size: 11px;
      }

      .funnel {
        height: 150px;
        gap: 6px;
        padding: 0 2px;
      }

      .funnel-value {
        font-size: 11px;
      }

      .funnel-label {
        font-size: 8px;
      }

      .funnel-bar {
        max-width: 50px;
      }

      .bar-label {
        width: 80px;
        font-size: 11px;
      }

      .panel-header h3 {
        font-size: 14px;
      }

      .panel {
        padding: 12px;
      }

      .setup-notice {
        padding: 14px;
      }

      .sb-status {
        left: 12px;
        right: 12px;
        bottom: 16px;
      }

      .event-row {
        gap: 8px;
        padding: 8px 0;
      }

      .event-text {
        font-size: 11px;
      }

      .event-time {
        font-size: 10px;
      }

      .mobile-header {
        padding: 10px 12px;
        height: 50px;
      }
    }

    @media (max-width: 480px) {
      .toast-container {
        top: 60px;
        right: 8px;
        left: 8px;
      }

      .toast {
        min-width: unset;
        max-width: 100%;
        padding: 12px 14px;
      }

      .toast-icon {
        width: 36px;
        height: 36px;
        font-size: 18px;
      }

      .toast-payout {
        font-size: 16px;
      }

      .toast-title {
        font-size: 13px;
      }

      .toast-msg {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>

  <!-- Password Gate -->
  <div class="pw-gate" id="pwGate">
    <div class="pw-logo">Vegas <span>Sweeps</span></div>
    <h2>Analytics Dashboard</h2>
    <p>Enter password to continue</p>
    <input type="password" id="pwInput" placeholder="Password" autocomplete="off" autofocus>
    <div class="pw-error" id="pwError"></div>
    <button onclick="checkPw()">Unlock</button>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Mobile Header (outside flex container) -->
  <div class="mobile-header" id="mobileHeader">
    <div class="sb-logo">Vegas <span>Sweeps</span></div>
    <button class="hamburger" onclick="toggleSidebar()" aria-label="Menu">
      <ion-icon name="menu"></ion-icon>
    </button>
  </div>

  <!-- Sidebar Overlay -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <div class="app" id="appMain" style="display:none">

    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="sb-logo">Vegas <span>Sweeps</span></div>
      <div class="sb-sub">Analytics</div>
      <ul class="sb-nav">
        <li class="active" data-tab="overview">
          <ion-icon name="grid"></ion-icon> Overview
        </li>
        <li data-tab="conversions">
          <ion-icon name="trending-up"></ion-icon> Conversions
        </li>
        <li data-tab="games">
          <ion-icon name="game-controller"></ion-icon> Games
        </li>
        <li data-tab="geo">
          <ion-icon name="globe"></ion-icon> Countries
        </li>
        <li data-tab="events">
          <ion-icon name="list"></ion-icon> Live Events
        </li>
      </ul>
      <div class="sb-status" id="fbStatus">
        <span class="dot off"></span>
        <span>Checking Firebase...</span>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="main">

      <!-- Header -->
      <div class="page-header">
        <h1 id="pageTitle">Overview</h1>
        <div class="date-range">
          <button class="date-btn active" data-range="today">Today</button>
          <button class="date-btn" data-range="7d">7 Days</button>
          <button class="date-btn" data-range="30d">30 Days</button>
          <button class="date-btn" data-range="all">All Time</button>
        </div>
      </div>

      <!-- Content area -->
      <div id="content">
        <div class="loading">
          <div class="spinner"></div> Connecting to Firebase...
        </div>
      </div>

    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <script>
    /* ==========================================================
       PASSWORD GATE
       ========================================================== */
    const PW_HASH = '73b29ab7bc9fef71b7c5203d38816734a71b6b74af48efc9a8f176c7a8ac7422'; // sha256 of 'vs777admin'
    const PW_SESSION_KEY = 'vs7_dash_auth';

    async function sha256(str) {
      const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    function checkPw() {
      const val = document.getElementById('pwInput').value;
      sha256(val).then(hash => {
        if (hash === PW_HASH) {
          sessionStorage.setItem(PW_SESSION_KEY, '1');
          unlockDash();
        } else {
          document.getElementById('pwError').textContent = 'Wrong password';
          document.getElementById('pwInput').value = '';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('pwInput').addEventListener('keydown', e => {
        if (e.key === 'Enter') checkPw();
      });
      if (sessionStorage.getItem(PW_SESSION_KEY) === '1') unlockDash();
    });

    function unlockDash() {
      document.getElementById('pwGate').classList.add('hidden');
      document.getElementById('appMain').style.display = '';
      var mh = document.getElementById('mobileHeader');
      if (mh && window.innerWidth <= 768) mh.style.display = 'flex';
      initDashboard();
    }

    /* ==========================================================
       MOBILE SIDEBAR TOGGLE
       ========================================================== */
    function toggleSidebar() {
      document.querySelector('.sidebar').classList.toggle('open');
      document.getElementById('sidebarOverlay').classList.toggle('active');
    }
    // Close sidebar when nav item clicked on mobile
    document.addEventListener('click', function (e) {
      const li = e.target.closest('.sb-nav li');
      if (li && window.innerWidth <= 768) {
        document.querySelector('.sidebar').classList.remove('open');
        document.getElementById('sidebarOverlay').classList.remove('active');
      }
    });

    /* ==========================================================
       FIREBASE CONFIG â€” Must match tracker.js
       ========================================================== */
    const firebaseConfig = {
      apiKey: "AIzaSyBcbWyAERVCw3fOadYUdB7TNVXBbZdIsHE",
      authDomain: "vegassweeps-analytics.firebaseapp.com",
      projectId: "vegassweeps-analytics",
      storageBucket: "vegassweeps-analytics.firebasestorage.app",
      messagingSenderId: "760086690909",
      appId: "1:760086690909:web:fb462a71c84c88ee8321b4",
      measurementId: "G-WZFJ4NCSLM"
    };

    const DB_PREFIX = 'vs7_';
    const CONFIGURED = firebaseConfig.apiKey !== 'YOUR_API_KEY';
    let db = null;
    let activeTab = 'overview';
    let activeRange = 'today';

    /* ==========================================================
       INIT
       ========================================================== */
    function initDashboard() {
      // Firebase status
      const statusEl = document.getElementById('fbStatus');
      if (!CONFIGURED) {
        statusEl.innerHTML = '<span class="dot off"></span> Not configured';
        showSetupNotice();
        return;
      }

      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      statusEl.innerHTML = '<span class="dot on"></span> Firebase connected';

      // Start real-time listener for new conversions (toasts)
      listenForNewLeads();
      // Start real-time listener for active lockers
      listenForActiveLockers();

      loadTab('overview');

      // Nav clicks
      document.querySelectorAll('.sb-nav li').forEach(li => {
        li.addEventListener('click', () => {
          document.querySelectorAll('.sb-nav li').forEach(l => l.classList.remove('active'));
          li.classList.add('active');
          activeTab = li.dataset.tab;
          document.getElementById('pageTitle').textContent =
            li.textContent.trim();
          loadTab(activeTab);
        });
      });

      // Date range
      document.querySelectorAll('.date-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeRange = btn.dataset.range;
          loadTab(activeTab);
        });
      });
    }

    /* ==========================================================
       SETUP NOTICE
       ========================================================== */
    function showSetupNotice() {
      document.getElementById('content').innerHTML = `
        <div class="setup-notice">
          <h3>âš¡ Firebase Setup Required</h3>
          <p>To start collecting analytics data, you need to create a free Firebase project and add your config:</p>
          <ol>
            <li>Go to <a href="https://console.firebase.google.com" target="_blank" style="color:var(--primary)">console.firebase.google.com</a></li>
            <li>Click <strong>Add project</strong> â†’ name it (e.g. "vegassweeps-analytics")</li>
            <li>Once created, click the <strong>Web</strong> icon (<strong>&lt;/&gt;</strong>) to register a web app</li>
            <li>Copy the <code>firebaseConfig</code> object</li>
            <li>Paste it into <code>assets/js/tracker.js</code> AND <code>dashboard/index.html</code></li>
            <li>In Firebase Console â†’ <strong>Firestore Database</strong> â†’ <strong>Create Database</strong> â†’ Start in <strong>Test Mode</strong></li>
            <li>Deploy your site and data will flow automatically!</li>
          </ol>
          <p style="margin-top:16px">Once configured, this dashboard will show:</p>
        </div>

        ${getDemoHTML()}
      `;
    }

    /* ==========================================================
       DEMO DATA (shown when Firebase not configured)
       ========================================================== */
    function getDemoHTML() {
      return `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="label">Page Views</div>
            <div class="value">1,247</div>
            <div class="change up">â†‘ 12% vs yesterday</div>
          </div>
          <div class="stat-card">
            <div class="label">Signup Clicks</div>
            <div class="value">384</div>
            <div class="change up">â†‘ 8% vs yesterday</div>
          </div>
          <div class="stat-card">
            <div class="label">Offers Clicked</div>
            <div class="value">96</div>
            <div class="change up">â†‘ 15% vs yesterday</div>
          </div>
          <div class="stat-card">
            <div class="label">Offers Completed / Leads</div>
            <div class="value" style="color:var(--purple)">12</div>
            <div class="change up">â†‘ 3 vs yesterday</div>
          </div>
          <div class="stat-card">
            <div class="label">Completion Rate</div>
            <div class="value">12.5%</div>
            <div class="change up">â†‘ 2.1% vs yesterday</div>
          </div>
          <div class="stat-card">
            <div class="label">Revenue</div>
            <div class="value" style="color:var(--warning)">$8.64</div>
            <div class="change up">â†‘ $2.10 vs yesterday</div>
          </div>
          <div class="stat-card">
            <div class="label">Accounts Activated</div>
            <div class="value" style="color:var(--success)">42</div>
            <div class="change up">â†‘ 21% vs yesterday</div>
          </div>
          <div class="stat-card">
            <div class="label">Conversion Rate</div>
            <div class="value">3.4%</div>
            <div class="change up">â†‘ 0.3% vs yesterday</div>
          </div>
        </div>

        <div class="grid-2">
          <div class="panel">
            <div class="panel-header"><h3>Conversion Funnel</h3></div>
            <div class="funnel">
              <div class="funnel-step">
                <div class="funnel-bar" style="height:130px;background:var(--primary)"></div>
                <div class="funnel-value">1,247</div>
                <div class="funnel-label">Views</div>
              </div>
              <div class="funnel-step">
                <div class="funnel-bar" style="height:85px;background:var(--warning)"></div>
                <div class="funnel-value">384</div>
                <div class="funnel-label">Signups</div>
              </div>
              <div class="funnel-step">
                <div class="funnel-bar" style="height:40px;background:var(--purple)"></div>
                <div class="funnel-value">96</div>
                <div class="funnel-label">Clicked</div>
              </div>
              <div class="funnel-step">
                <div class="funnel-bar" style="height:32px;background:#f97316"></div>
                <div class="funnel-value" style="color:#f97316">68</div>
                <div class="funnel-label">Leads</div>
              </div>
              <div class="funnel-step">
                <div class="funnel-bar" style="height:25px;background:var(--success)"></div>
                <div class="funnel-value" style="color:var(--success)">42</div>
                <div class="funnel-label">Activated</div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="panel-header"><h3>Top Countries</h3></div>
            <div class="bar-row">
              <div class="bar-label">ðŸ‡ºðŸ‡¸ United States</div>
              <div class="bar-track"><div class="bar-fill blue" style="width:72%">72%</div></div>
            </div>
            <div class="bar-row">
              <div class="bar-label">ðŸ‡¨ðŸ‡¦ Canada</div>
              <div class="bar-track"><div class="bar-fill green" style="width:12%">12%</div></div>
            </div>
            <div class="bar-row">
              <div class="bar-label">ðŸ‡¬ðŸ‡§ United Kingdom</div>
              <div class="bar-track"><div class="bar-fill purple" style="width:8%">8%</div></div>
            </div>
            <div class="bar-row">
              <div class="bar-label">ðŸ‡¦ðŸ‡º Australia</div>
              <div class="bar-track"><div class="bar-fill orange" style="width:5%">5%</div></div>
            </div>
          </div>
        </div>

        <div class="grid-2">
          <div class="panel">
            <div class="panel-header"><h3>Top Games</h3></div>
            <table class="data-table">
              <thead>
                <tr><th>Game</th><th>Clicks</th><th>Activated</th><th>Rate</th></tr>
              </thead>
              <tbody>
                <tr><td>Vegas Sweeps</td><td>82</td><td>12</td><td style="color:var(--success)">14.6%</td></tr>
                <tr><td>Fire Kirin</td><td>71</td><td>9</td><td style="color:var(--success)">12.7%</td></tr>
                <tr><td>Game Vault</td><td>54</td><td>7</td><td style="color:var(--success)">13.0%</td></tr>
                <tr><td>Black Jack</td><td>48</td><td>5</td><td style="color:var(--warning)">10.4%</td></tr>
                <tr><td>Ultra Panda</td><td>39</td><td>4</td><td style="color:var(--warning)">10.3%</td></tr>
              </tbody>
            </table>
          </div>

          <div class="panel">
            <div class="panel-header"><h3>Recent Events (Sample)</h3></div>
            <div class="event-row">
              <div class="event-dot activated"></div>
              <div class="event-text"><strong>Account Activated</strong> â€” Vegas Sweeps â€” US</div>
              <div class="event-time">2m ago</div>
            </div>
            <div class="event-row">
              <div class="event-dot offer"></div>
              <div class="event-text"><strong>Offer Clicked</strong> â€” Fire Kirin â€” CA</div>
              <div class="event-time">5m ago</div>
            </div>
            <div class="event-row">
              <div class="event-dot coupon"></div>
              <div class="event-text"><strong>Coupon Applied</strong> â€” CLAIM10 â€” Game Vault</div>
              <div class="event-time">8m ago</div>
            </div>
            <div class="event-row">
              <div class="event-dot signup"></div>
              <div class="event-text"><strong>Signup Click</strong> â€” Black Jack â€” US</div>
              <div class="event-time">11m ago</div>
            </div>
            <div class="event-row">
              <div class="event-dot view"></div>
              <div class="event-text"><strong>Page View</strong> â€” Homepage â€” GB</div>
              <div class="event-time">12m ago</div>
            </div>
          </div>
        </div>

        <p style="text-align:center;color:var(--text-muted);font-size:13px;margin-top:8px;font-style:italic">
          â†‘ Demo data â€” configure Firebase to see real analytics
        </p>
      `;
    }

    /* ==========================================================
       LIVE DATA LOADING
       ========================================================== */
    async function loadTab(tab) {
      if (!db) return;
      const content = document.getElementById('content');
      content.innerHTML = '<div class="loading"><div class="spinner"></div> Loading data...</div>';

      try {
        switch (tab) {
          case 'overview': await loadOverview(content); break;
          case 'conversions': await loadConversions(content); break;
          case 'games': await loadGames(content); break;
          case 'geo': await loadGeo(content); break;
          case 'events': await loadEvents(content); break;
        }
      } catch (e) {
        content.innerHTML = `<div class="setup-notice"><h3>Error loading data</h3><p>${e.message}</p></div>`;
      }
    }

    function getDateRange() {
      const now = new Date();
      const today = now.toISOString().slice(0, 10);
      if (activeRange === 'today') return { start: today, end: today };
      const d = new Date(now);
      if (activeRange === '7d') d.setDate(d.getDate() - 7);
      else if (activeRange === '30d') d.setDate(d.getDate() - 30);
      else d.setFullYear(2020);
      return { start: d.toISOString().slice(0, 10), end: today };
    }

    /* ---- Overview ---- */
    async function loadOverview(el) {
      const range = getDateRange();
      const statsSnap = await db.collection(DB_PREFIX + 'daily_stats')
        .where('date', '>=', range.start)
        .where('date', '<=', range.end)
        .get();

      let totals = { total_views: 0, signup_clicks: 0, offers_started: 0, offers_clicked: 0, accounts_activated: 0, coupons_applied: 0, processing_started: 0, conversions: 0, revenue: 0, chargebacks: 0 };
      statsSnap.forEach(doc => {
        const d = doc.data();
        Object.keys(totals).forEach(k => { totals[k] += d[k] || 0; });
      });

      const convRate = totals.total_views > 0
        ? ((totals.accounts_activated / totals.total_views) * 100).toFixed(1) + '%'
        : '0%';

      const completionRate = totals.offers_clicked > 0
        ? ((totals.conversions / totals.offers_clicked) * 100).toFixed(1) + '%'
        : '0%';

      // Get recent events
      const eventsSnap = await db.collection(DB_PREFIX + 'events')
        .orderBy('timestamp', 'desc')
        .limit(8)
        .get();
      let eventsHTML = '';
      eventsSnap.forEach(doc => {
        const d = doc.data();
        const type = d.event || 'unknown';
        const dotClass = type.includes('activated') ? 'activated'
          : type.includes('offer') ? 'offer'
            : type.includes('coupon') ? 'coupon'
              : type.includes('signup') ? 'signup' : 'view';
        const time = d.localTime ? timeAgo(new Date(d.localTime)) : '';
        const game = d.gameName || '';
        const country = d.countryCode || '';
        eventsHTML += `<div class="event-row">
          <div class="event-dot ${dotClass}"></div>
          <div class="event-text"><strong>${formatEventName(type)}</strong>${game ? ' â€” ' + game : ''}${country ? ' â€” ' + country : ''}</div>
          <div class="event-time">${time}</div>
        </div>`;
      });

      // Get country data (client-side filter to avoid composite index)
      const countrySnap = await db.collection(DB_PREFIX + 'events')
        .orderBy('timestamp', 'desc')
        .limit(300)
        .get();
      const countryCounts = {};
      countrySnap.forEach(doc => {
        const d = doc.data();
        if (d.event !== 'page_view') return;
        const c = d.country || 'Unknown';
        const cc = d.countryCode || 'XX';
        const key = cc + '|' + c;
        countryCounts[key] = (countryCounts[key] || 0) + 1;
      });
      const countries = Object.entries(countryCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
      const maxCountry = countries.length > 0 ? countries[0][1] : 1;

      let countryBars = '';
      countries.forEach(([key, count]) => {
        const [cc, name] = key.split('|');
        const pct = Math.round((count / maxCountry) * 100);
        const flag = countryFlag(cc);
        const colors = ['blue', 'green', 'purple', 'orange', 'blue'];
        const color = colors[countries.indexOf([key, count])] || 'blue';
        countryBars += `<div class="bar-row">
          <div class="bar-label">${flag} ${name}</div>
          <div class="bar-track"><div class="bar-fill blue" style="width:${pct}%">${count}</div></div>
        </div>`;
      });

      el.innerHTML = `
        <div class="stats-grid">
          <div class="stat-card"><div class="label">Page Views</div><div class="value">${totals.total_views.toLocaleString()}</div></div>
          <div class="stat-card"><div class="label">Signup Clicks</div><div class="value">${totals.signup_clicks.toLocaleString()}</div></div>
          <div class="stat-card"><div class="label">Offers Clicked</div><div class="value">${totals.offers_clicked.toLocaleString()}</div></div>
          <div class="stat-card"><div class="label">Offers Completed / Leads</div><div class="value" style="color:var(--purple)">${totals.conversions.toLocaleString()}</div></div>
          <div class="stat-card"><div class="label">Completion Rate</div><div class="value">${completionRate}</div></div>
          <div class="stat-card"><div class="label">Revenue</div><div class="value" style="color:var(--warning)">$${totals.revenue.toFixed(2)}</div></div>
          <div class="stat-card"><div class="label">Accounts Activated</div><div class="value" style="color:var(--success)">${totals.accounts_activated.toLocaleString()}</div></div>
          <div class="stat-card"><div class="label">Conversion Rate</div><div class="value">${convRate}</div></div>
          <div class="stat-card"><div class="label">Coupons Used</div><div class="value">${totals.coupons_applied.toLocaleString()}</div></div>
        </div>

        <div class="panel" style="margin-bottom:16px">
          <div class="panel-header">
            <h3><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:#ef4444;margin-right:6px;animation:pulseDot 1.5s infinite"></span>Locker Performance <span style="font-weight:400;font-size:12px;color:var(--text-muted)">(real-time from ad network)</span></h3>
          </div>
          <div class="active-lockers-grid" id="activeLockers">
            ${lockerListenerReady ? '' : '<p style="color:var(--text-muted);font-size:13px;padding:8px 0">Loading real-time data...</p>'}
          </div>
        </div>

        <div class="grid-2">
          <div class="panel">
            <div class="panel-header"><h3>Conversion Funnel</h3></div>
            <div class="funnel">
              <div class="funnel-step">
                <div class="funnel-bar" style="height:${barH(totals.total_views, totals.total_views)}px;background:var(--primary)"></div>
                <div class="funnel-value">${totals.total_views.toLocaleString()}</div>
                <div class="funnel-label">Views</div>
              </div>
              <div class="funnel-step">
                <div class="funnel-bar" style="height:${barH(totals.signup_clicks, totals.total_views)}px;background:var(--warning)"></div>
                <div class="funnel-value">${totals.signup_clicks.toLocaleString()}</div>
                <div class="funnel-label">Signups</div>
              </div>
              <div class="funnel-step">
                <div class="funnel-bar" style="height:${barH(totals.offers_clicked, totals.total_views)}px;background:var(--purple)"></div>
                <div class="funnel-value">${totals.offers_clicked.toLocaleString()}</div>
                <div class="funnel-label">Offers Clicked</div>
              </div>
              <div class="funnel-step">
                <div class="funnel-bar" style="height:${barH(totals.conversions, totals.total_views)}px;background:#f97316"></div>
                <div class="funnel-value" style="color:#f97316">${totals.conversions.toLocaleString()}</div>
                <div class="funnel-label">Leads</div>
              </div>
              <div class="funnel-step">
                <div class="funnel-bar" style="height:${barH(totals.accounts_activated, totals.total_views)}px;background:var(--success)"></div>
                <div class="funnel-value" style="color:var(--success)">${totals.accounts_activated.toLocaleString()}</div>
                <div class="funnel-label">Activated</div>
              </div>
            </div>
          </div>
          <div class="panel">
            <div class="panel-header"><h3>Top Countries</h3></div>
            ${countryBars || '<p style="color:var(--text-muted);font-size:13px">No data yet</p>'}
          </div>
        </div>

        <div class="panel">
          <div class="panel-header"><h3>Recent Events</h3></div>
          ${eventsHTML || '<p style="color:var(--text-muted);font-size:13px">No events recorded yet. Visit your site to generate data.</p>'}
        </div>
      `;

      // Render locker data if already loaded by the real-time listener
      if (lockerListenerReady) renderActiveLockers();
    }

    /* ---- Conversions ---- */
    async function loadConversions(el) {
      const range = getDateRange();
      const snap = await db.collection(DB_PREFIX + 'daily_stats')
        .where('date', '>=', range.start)
        .where('date', '<=', range.end)
        .orderBy('date', 'desc')
        .get();

      let rows = '';
      snap.forEach(doc => {
        const d = doc.data();
        const views = d.total_views || 0;
        const signups = d.signup_clicks || 0;
        const offers = d.offers_clicked || 0;
        const activated = d.accounts_activated || 0;
        const rate = views > 0 ? ((activated / views) * 100).toFixed(1) + '%' : 'â€”';
        const convCount = d.conversions || 0;
        const rev = d.revenue || 0;
        const cb = d.chargebacks || 0;
        rows += `<tr>
          <td>${d.date}</td>
          <td>${views.toLocaleString()}</td>
          <td>${signups.toLocaleString()}</td>
          <td>${(d.coupons_applied || 0).toLocaleString()}</td>
          <td>${offers.toLocaleString()}</td>
          <td style="color:var(--success);font-weight:700">${activated.toLocaleString()}</td>
          <td>${rate}</td>
          <td style="color:#10b981;font-weight:700">${convCount}</td>
          <td style="color:#f59e0b;font-weight:700">$${rev.toFixed(2)}</td>
          <td style="color:${cb > 0 ? '#ef4444' : 'var(--text-muted)'}">${cb}</td>
        </tr>`;
      });

      // Load recent postback conversions
      let postbackRows = '';
      let totalRevenue = 0;
      let totalConversions = 0;
      let totalChargebacks = 0;
      try {
        const convSnap = await db.collection(DB_PREFIX + 'conversions')
          .orderBy('timestamp', 'desc')
          .limit(50)
          .get();

        convSnap.forEach(doc => {
          const c = doc.data();
          const isChargebk = c.is_chargeback === true;
          const payout = c.payout || 0;
          if (!isChargebk) { totalConversions++; totalRevenue += payout; }
          else { totalChargebacks++; }
          const payoutTime = c.timestamp ? c.timestamp.toDate() : null;
          const payoutTimeStr = payoutTime ? payoutTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : 'â€”';
          const payoutAgo = payoutTime ? timeAgo(payoutTime) : '';
          // Click time from ad network unix timestamp
          const clickUnix = c.unix ? parseInt(c.unix) : 0;
          const clickTime = clickUnix > 0 ? new Date(clickUnix * 1000) : null;
          const clickTimeStr = clickTime ? clickTime.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : 'â€”';
          // Time to convert
          const ttc = (clickTime && payoutTime) ? Math.round((payoutTime - clickTime) / 1000) : 0;
          const ttcStr = ttc > 0 ? (ttc < 60 ? ttc + 's' : ttc < 3600 ? Math.round(ttc / 60) + 'm' : Math.round(ttc / 3600) + 'h') : '';
          // Locker name from s1
          const lockerName = c.s1 || 'â€”';
          postbackRows += `<tr>
            <td style="font-weight:600">${c.offer_name || c.offer_id || 'â€”'}</td>
            <td><span style="display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:8px;font-size:12px;font-weight:700;background:rgba(99,102,241,0.1);color:#818cf8">${lockerName}</span></td>
            <td style="color:${isChargebk ? '#ef4444' : '#10b981'};font-weight:700">$${payout.toFixed(2)}</td>
            <td><span style="display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;${isChargebk ? 'background:rgba(239,68,68,0.1);color:#ef4444' : 'background:rgba(16,185,129,0.1);color:#10b981'}">${isChargebk ? 'âœ• Chargeback' : 'âœ“ Conversion'}</span></td>
            <td>${c.country_code || 'â€”'}</td>
            <td style="font-size:12px;color:var(--text-muted)" title="${clickTimeStr}">${clickTimeStr}${ttcStr ? '<br><span style="font-size:10px;color:#a78bfa">â†’ ' + ttcStr + ' to convert</span>' : ''}</td>
            <td style="font-size:12px" title="${payoutTimeStr}"><span style="font-weight:600">${payoutTimeStr}</span><br><span style="font-size:10px;color:var(--text-muted)">${payoutAgo}</span></td>
            <td style="font-family:monospace;font-size:11px">${c.lead_id || 'â€”'}</td>
            <td style="font-size:12px">${c.ip || 'â€”'}</td>
          </tr>`;
        });
      } catch (e) { console.warn('Failed to load conversions:', e); }

      el.innerHTML = `
        <div class="stats-grid" style="grid-template-columns:repeat(3,1fr)">
          <div class="stat-card">
            <div class="stat-label">Postback Conversions</div>
            <div class="stat-value" style="color:#10b981">${totalConversions}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value" style="color:#f59e0b">$${totalRevenue.toFixed(2)}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Chargebacks</div>
            <div class="stat-value" style="color:#ef4444">${totalChargebacks}</div>
          </div>
        </div>
        <div class="panel" style="margin-bottom:20px">
          <div class="panel-header"><h3>Daily Breakdown</h3></div>
          <div style="overflow-x:auto">
          <table class="data-table">
            <thead>
              <tr><th>Date</th><th>Views</th><th>Signups</th><th>Coupons</th><th>Clicked</th><th>Activated</th><th>Rate</th><th>Leads</th><th>Revenue</th><th>CB</th></tr>
            </thead>
            <tbody>${rows || '<tr><td colspan="10" style="color:var(--text-muted)">No data yet</td></tr>'}</tbody>
          </table>
          </div>
        </div>
        <div class="panel">
          <div class="panel-header"><h3>Recent Postback Conversions</h3></div>
          <div style="overflow-x:auto">
          <table class="data-table">
            <thead>
              <tr><th>Offer</th><th>Locker</th><th>Payout</th><th>Status</th><th>Country</th><th>Clicked At</th><th>Payout Time</th><th>Lead ID</th><th>IP</th></tr>
            </thead>
            <tbody>${postbackRows || '<tr><td colspan="9" style="color:var(--text-muted)">No postback conversions yet. Set your postback URL in the ad network to start receiving data.</td></tr>'}</tbody>
          </table>
          </div>
        </div>
      `;
    }

    /* ---- Games ---- */
    async function loadGames(el) {
      const snap = await db.collection(DB_PREFIX + 'game_stats').get();
      let rows = '';
      const games = [];
      snap.forEach(doc => games.push(doc.data()));
      games.sort((a, b) => (b.total_signups || 0) - (a.total_signups || 0));

      games.forEach(g => {
        const last = g.last_signup ? timeAgo(g.last_signup.toDate()) : 'â€”';
        rows += `<tr>
          <td style="font-weight:600">${g.gameName || 'â€”'}</td>
          <td style="color:var(--success);font-weight:700">${(g.total_signups || 0).toLocaleString()}</td>
          <td>${last}</td>
        </tr>`;
      });

      // Bar chart
      let bars = '';
      const maxSignups = games.length > 0 ? games[0].total_signups || 1 : 1;
      const barColors = ['blue', 'green', 'purple', 'orange'];
      games.forEach((g, i) => {
        const pct = Math.round(((g.total_signups || 0) / maxSignups) * 100);
        bars += `<div class="bar-row">
          <div class="bar-label">${g.gameName || 'â€”'}</div>
          <div class="bar-track"><div class="bar-fill ${barColors[i % barColors.length]}" style="width:${Math.max(pct, 3)}%">${g.total_signups || 0}</div></div>
        </div>`;
      });

      el.innerHTML = `
        <div class="panel" style="margin-bottom:16px">
          <div class="panel-header"><h3>Game Performance</h3></div>
          ${bars || '<p style="color:var(--text-muted);font-size:13px">No game data yet</p>'}
        </div>
        <div class="panel">
          <div class="panel-header"><h3>Signups by Game</h3></div>
          <table class="data-table">
            <thead><tr><th>Game</th><th>Total Signups</th><th>Last Signup</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="3" style="color:var(--text-muted)">No data yet</td></tr>'}</tbody>
          </table>
        </div>
      `;
    }

    /* ---- Geo ---- */
    async function loadGeo(el) {
      const snap = await db.collection(DB_PREFIX + 'events')
        .orderBy('timestamp', 'desc')
        .limit(500)
        .get();

      const countries = {};
      const devices = { mobile: 0, desktop: 0, tablet: 0 };
      const browsers = {};

      snap.forEach(doc => {
        const d = doc.data();
        const country = d.country || 'Unknown';
        const cc = d.countryCode || 'XX';
        const key = cc + '|' + country;
        if (!countries[key]) countries[key] = { views: 0, signups: 0, activated: 0 };
        countries[key].views++;
        if (d.event === 'signup_click') countries[key].signups++;
        if (d.event === 'account_activated') countries[key].activated++;

        if (d.device) devices[d.device] = (devices[d.device] || 0) + 1;
        if (d.browser) browsers[d.browser] = (browsers[d.browser] || 0) + 1;
      });

      const sorted = Object.entries(countries).sort((a, b) => b[1].views - a[1].views);

      let rows = '';
      sorted.forEach(([key, data]) => {
        const [cc, name] = key.split('|');
        rows += `<tr>
          <td><div class="country-row"><span class="country-flag">${countryFlag(cc)}</span> ${name}</div></td>
          <td>${data.views}</td>
          <td>${data.signups}</td>
          <td style="color:var(--success)">${data.activated}</td>
        </tr>`;
      });

      const totalDev = Object.values(devices).reduce((a, b) => a + b, 0) || 1;
      let deviceBars = '';
      Object.entries(devices).sort((a, b) => b[1] - a[1]).forEach(([name, count]) => {
        const pct = Math.round((count / totalDev) * 100);
        deviceBars += `<div class="bar-row">
          <div class="bar-label">${name.charAt(0).toUpperCase() + name.slice(1)}</div>
          <div class="bar-track"><div class="bar-fill green" style="width:${Math.max(pct, 3)}%">${pct}%</div></div>
        </div>`;
      });

      el.innerHTML = `
        <div class="grid-2">
          <div class="panel">
            <div class="panel-header"><h3>Countries</h3></div>
            <table class="data-table">
              <thead><tr><th>Country</th><th>Views</th><th>Signups</th><th>Activated</th></tr></thead>
              <tbody>${rows || '<tr><td colspan="4" style="color:var(--text-muted)">No data yet</td></tr>'}</tbody>
            </table>
          </div>
          <div class="panel">
            <div class="panel-header"><h3>Devices</h3></div>
            ${deviceBars || '<p style="color:var(--text-muted);font-size:13px">No data yet</p>'}
          </div>
        </div>
      `;
    }

    /* ---- Live Events ---- */
    async function loadEvents(el) {
      // Real-time listener
      el.innerHTML = `<div class="panel">
        <div class="panel-header"><h3>Live Events</h3><span style="font-size:12px;color:var(--success)">â— Real-time</span></div>
        <div id="liveEvents"><div class="loading"><div class="spinner"></div> Listening for events...</div></div>
      </div>`;

      const container = document.getElementById('liveEvents');

      db.collection(DB_PREFIX + 'events')
        .orderBy('timestamp', 'desc')
        .limit(30)
        .onSnapshot(snap => {
          let html = '';
          snap.forEach(doc => {
            const d = doc.data();
            const type = d.event || 'unknown';
            const dotClass = type.includes('activated') ? 'activated'
              : type.includes('offer') ? 'offer'
                : type.includes('coupon') ? 'coupon'
                  : type.includes('signup') ? 'signup' : 'view';
            const time = d.localTime ? timeAgo(new Date(d.localTime)) : '';
            const game = d.gameName || '';
            const country = d.country || '';
            const cc = d.countryCode || '';
            const device = d.device || '';
            html += `<div class="event-row">
              <div class="event-dot ${dotClass}"></div>
              <div class="event-text">
                <strong>${formatEventName(type)}</strong>
                ${game ? ' â€” ' + game : ''}
                ${country ? ' â€” ' + countryFlag(cc) + ' ' + country : ''}
                ${device ? ' <span style="color:var(--text-muted)">(' + device + ')</span>' : ''}
              </div>
              <div class="event-time">${time}</div>
            </div>`;
          });
          container.innerHTML = html || '<p style="color:var(--text-muted);font-size:13px;padding:20px">No events yet. Visit your site to generate data.</p>';
        });
    }

    /* ==========================================================
       LOCKER PERFORMANCE â€” REAL-TIME FROM AD NETWORK
       ========================================================== */
    let lockerData = {};
    let lockerListenerReady = false;

    function listenForActiveLockers() {
      if (!db) return;
      // Listen to conversions in real-time (postback data from ad network)
      db.collection(DB_PREFIX + 'conversions')
        .orderBy('timestamp', 'desc')
        .limit(200)
        .onSnapshot(snap => {
          const fresh = {};

          snap.forEach(doc => {
            const c = doc.data();
            // s1 = locker name passed via offer URL, fallback to offer name/id
            const locker = c.s1 || c.offer_name || c.offer_id || 'Unknown';
            const ts = c.timestamp ? c.timestamp.toDate().getTime() : 0;
            const isChargebk = c.is_chargeback === true;
            const payout = c.payout || 0;

            if (!fresh[locker]) fresh[locker] = {
              conversions: 0, revenue: 0, chargebacks: 0,
              lastSeen: 0, countries: new Set(), offers: new Set(),
              ips: new Set(), firstSeen: Infinity
            };
            const entry = fresh[locker];
            if (ts > entry.lastSeen) entry.lastSeen = ts;
            if (ts < entry.firstSeen) entry.firstSeen = ts;
            if (c.country_code) entry.countries.add(c.country_code);
            if (c.offer_name || c.offer_id) entry.offers.add(c.offer_name || c.offer_id);
            if (c.ip) entry.ips.add(c.ip);

            if (isChargebk) {
              entry.chargebacks++;
            } else {
              entry.conversions++;
              entry.revenue += payout;
            }
          });

          lockerData = fresh;
          lockerListenerReady = true;
          renderActiveLockers();
        });
    }

    function renderActiveLockers() {
      const container = document.getElementById('activeLockers');
      if (!container) return;

      const entries = Object.entries(lockerData)
        .map(([name, d]) => ({
          name,
          conversions: d.conversions,
          revenue: d.revenue,
          chargebacks: d.chargebacks,
          countries: d.countries,
          offers: d.offers,
          uniqueIPs: d.ips.size,
          lastSeen: d.lastSeen,
          firstSeen: d.firstSeen,
          total: d.conversions + d.chargebacks
        }))
        .sort((a, b) => b.revenue - a.revenue);

      if (entries.length === 0) {
        container.innerHTML = '<p style="color:var(--text-muted);font-size:13px;padding:8px 0">No locker conversions yet. Conversions will appear here in real-time as postbacks come in.</p>';
        return;
      }

      const maxRev = Math.max(...entries.map(e => e.revenue), 1);
      const now = Date.now();

      container.innerHTML = entries.map(l => {
        const ago = now - l.lastSeen;
        const isRecent = ago < 60 * 60 * 1000; // last hour
        const isHot = l.conversions >= 3 || l.revenue >= 2;
        const agoStr = ago < 60000 ? 'just now'
          : ago < 3600000 ? Math.round(ago / 60000) + 'm ago'
            : ago < 86400000 ? Math.round(ago / 3600000) + 'h ago'
              : Math.round(ago / 86400000) + 'd ago';
        const barPct = Math.max(8, Math.round((l.revenue / maxRev) * 100));
        const flags = [...l.countries].slice(0, 4).map(cc => countryFlag(cc)).join(' ');
        const epc = l.conversions > 0 ? (l.revenue / l.conversions).toFixed(2) : '0.00';
        const offerList = [...l.offers].slice(0, 3).join(', ');

        return `<div class="locker-card${isHot ? ' hot' : ''}">
          <div class="locker-card-header">
            <span class="locker-card-name" title="${l.name}">${l.name}</span>
            <span class="locker-pulse${isRecent ? '' : ' idle'}" title="${isRecent ? 'Active recently' : 'Idle'}"></span>
          </div>
          <div class="locker-stats">
            <span class="locker-stat" title="Conversions"><ion-icon name="checkmark-circle" style="color:#10b981"></ion-icon> <strong style="color:#10b981">${l.conversions}</strong></span>
            <span class="locker-stat" title="Revenue"><ion-icon name="cash-outline" style="color:#f59e0b"></ion-icon> <strong style="color:#f59e0b">$${l.revenue.toFixed(2)}</strong></span>
            <span class="locker-stat" title="EPC (Earnings Per Conversion)"><ion-icon name="analytics-outline"></ion-icon> <strong>$${epc}</strong></span>
            ${l.chargebacks ? '<span class="locker-stat" title="Chargebacks"><ion-icon name="alert-circle" style="color:#ef4444"></ion-icon> <strong style="color:#ef4444">' + l.chargebacks + '</strong></span>' : ''}
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:4px">
            <span class="locker-last-activity">${agoStr} Â· ${l.uniqueIPs} unique IP${l.uniqueIPs !== 1 ? 's' : ''}${flags ? ' Â· ' + flags : ''}</span>
          </div>
          ${offerList ? '<div class="locker-last-activity" title="Offers: ' + offerList + '" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis"><ion-icon name="document-text-outline" style="font-size:12px;vertical-align:-1px"></ion-icon> ' + offerList + '</div>' : ''}
          <div class="locker-activity-bar"><div class="locker-activity-fill" style="width:${barPct}%"></div></div>
        </div>`;
      }).join('');
    }

    /* ==========================================================
       LEAD TOAST + SOUND
       ========================================================== */
    let leadListenerInitial = true;

    function listenForNewLeads() {
      if (!db) return;
      db.collection(DB_PREFIX + 'conversions')
        .orderBy('timestamp', 'desc')
        .limit(5)
        .onSnapshot(snap => {
          // Skip the initial load so we don't toast old data
          if (leadListenerInitial) {
            leadListenerInitial = false;
            return;
          }
          snap.docChanges().forEach(change => {
            if (change.type === 'added') {
              const data = change.doc.data();
              showLeadToast(data);
            }
          });
        });
    }

    function showLeadToast(data) {
      const payout = data.payout || 0;
      const offer = data.offer_name || data.offer_id || 'Unknown Offer';
      const country = data.country_code || '';
      const isChargeback = data.is_chargeback === true;

      // Play sound
      if (!isChargeback) {
        playKachingSound();
      } else {
        playErrorSound();
      }

      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';

      if (isChargeback) {
        toast.style.borderColor = 'rgba(239,68,68,0.3)';
        toast.style.borderLeftColor = '#ef4444';
        toast.querySelector && (toast.style.cssText += '--timer-color: #ef4444;');
      }

      const icon = isChargeback ? '<ion-icon name="alert-circle" style="font-size:22px;color:#ef4444"></ion-icon>' : '<ion-icon name="cash" style="font-size:22px;color:#10b981"></ion-icon>';
      const title = isChargeback ? 'Chargeback' : 'New Lead!';
      const titleColor = isChargeback ? '#ef4444' : '#10b981';
      const payoutColor = isChargeback ? '#ef4444' : '#f59e0b';
      const flag = country ? countryFlag(country) : '';

      toast.innerHTML = `
        <button class="toast-close" onclick="this.parentElement.classList.add('removing');setTimeout(()=>this.parentElement.remove(),400)">&times;</button>
        <div class="toast-icon">${icon}</div>
        <div class="toast-body">
          <div class="toast-title" style="color:${titleColor}">
            <span class="pulse-dot" style="background:${titleColor}"></span>
            ${title}
          </div>
          <div class="toast-msg"><strong>${offer}</strong>${flag ? ' &nbsp;' + flag : ''}</div>
        </div>
        <div class="toast-payout" style="color:${payoutColor}">$${payout.toFixed(2)}</div>
      `;

      if (isChargeback) {
        toast.style.borderLeftColor = '#ef4444';
        toast.style.borderColor = 'rgba(239,68,68,0.3)';
        const timerBar = toast.querySelector('::before');
      }

      container.appendChild(toast);

      // Auto-remove after 5.5s
      setTimeout(() => {
        toast.classList.add('removing');
        setTimeout(() => toast.remove(), 400);
      }, 5500);

      // Max 3 toasts visible
      while (container.children.length > 3) {
        container.firstChild.remove();
      }
    }

    // Ka-ching sound using Web Audio API
    function playKachingSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;

        // Coin hit - short metallic ping
        const osc1 = ctx.createOscillator();
        const gain1 = ctx.createGain();
        osc1.type = 'sine';
        osc1.frequency.setValueAtTime(1800, now);
        osc1.frequency.exponentialRampToValueAtTime(2400, now + 0.05);
        gain1.gain.setValueAtTime(0.3, now);
        gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
        osc1.connect(gain1).connect(ctx.destination);
        osc1.start(now);
        osc1.stop(now + 0.15);

        // Register slide
        const osc2 = ctx.createOscillator();
        const gain2 = ctx.createGain();
        osc2.type = 'sine';
        osc2.frequency.setValueAtTime(1200, now + 0.08);
        osc2.frequency.exponentialRampToValueAtTime(1600, now + 0.12);
        osc2.frequency.exponentialRampToValueAtTime(2000, now + 0.18);
        gain2.gain.setValueAtTime(0, now + 0.08);
        gain2.gain.linearRampToValueAtTime(0.25, now + 0.1);
        gain2.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
        osc2.connect(gain2).connect(ctx.destination);
        osc2.start(now + 0.08);
        osc2.stop(now + 0.35);

        // Bright chime
        const osc3 = ctx.createOscillator();
        const gain3 = ctx.createGain();
        osc3.type = 'sine';
        osc3.frequency.setValueAtTime(2600, now + 0.15);
        osc3.frequency.exponentialRampToValueAtTime(3200, now + 0.25);
        gain3.gain.setValueAtTime(0, now + 0.15);
        gain3.gain.linearRampToValueAtTime(0.2, now + 0.18);
        gain3.gain.exponentialRampToValueAtTime(0.01, now + 0.5);
        osc3.connect(gain3).connect(ctx.destination);
        osc3.start(now + 0.15);
        osc3.stop(now + 0.5);

        // Close context after sounds finish
        setTimeout(() => ctx.close(), 600);
      } catch (e) { /* Audio not supported */ }
    }

    // Error sound for chargebacks
    function playErrorSound() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const now = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'sawtooth';
        osc.frequency.setValueAtTime(400, now);
        osc.frequency.exponentialRampToValueAtTime(200, now + 0.3);
        gain.gain.setValueAtTime(0.15, now);
        gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
        osc.connect(gain).connect(ctx.destination);
        osc.start(now);
        osc.stop(now + 0.3);
        setTimeout(() => ctx.close(), 400);
      } catch (e) { }
    }

    /* ==========================================================
       HELPERS
       ========================================================== */
    function barH(val, max) {
      if (!max || !val) return 10;
      return Math.max(10, Math.round((val / max) * 130));
    }

    function timeAgo(date) {
      const diff = (Date.now() - date.getTime()) / 1000;
      if (diff < 60) return Math.round(diff) + 's ago';
      if (diff < 3600) return Math.round(diff / 60) + 'm ago';
      if (diff < 86400) return Math.round(diff / 3600) + 'h ago';
      return Math.round(diff / 86400) + 'd ago';
    }

    function formatEventName(event) {
      return event.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function countryFlag(cc) {
      if (!cc || cc === 'XX') return 'ðŸŒ';
      return String.fromCodePoint(...cc.toUpperCase().split('').map(c => 0x1F1E6 + c.charCodeAt(0) - 65));
    }

    /* ==========================================================
       BOOT â€” handled by password gate (unlockDash calls initDashboard)
       ========================================================== */
  </script>
</body>

</html>